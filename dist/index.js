var e=require("bitcore-mnemonic"),t=require("bitcoinjs-lib"),r=require("tiny-secp256k1"),n=require("ecpair"),s=require("@mempool/mempool.js"),o=require("bech32");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function a(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var u=/*#__PURE__*/a(e),c=/*#__PURE__*/a(r),h=/*#__PURE__*/i(s);function f(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}function d(e,t,r){if(!e.s){if(r instanceof l){if(!r.s)return void(r.o=d.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(d.bind(null,e,t),d.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}const l=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,s=this.s;if(s){const e=1&s?t:r;if(e){try{d(n,1,e(this.v))}catch(e){d(n,2,e)}return n}return this}return this.o=function(e){try{const s=e.v;1&e.s?d(n,1,t?t(s):s):r?d(n,1,r(s)):d(n,2,s)}catch(e){d(n,2,e)}},n},e}();t.initEccLib(c);const p=n.ECPairFactory(c);class v{constructor(){const e=this,r=this,n=this,s=this,i=this,a=this;this.createPassPhrase=()=>{try{return{passPhrase:new u(u.Words.ENGLISH).toString()}}catch(e){throw new Error(e.message)}},this.accountKeys=e=>{try{const t=this.getNetwork(e.networkName);let r=new u(e.passPhrase).toHDPrivateKey(e.passPhrase).derive(`m/44/0/0/0/${e.path}`).privateKey.toString(),n=p.fromPrivateKey(Buffer.from(r.slice(0,32)),{network:t});return{privateKey:n.privateKey.toString(),wif:n.toWIF()}}catch(e){throw new Error(e.message)}},this.createAddress=e=>{try{const r=this.getNetwork(e.networkName);let n,s,o;switch(e.privateKey?n=p.fromPrivateKey(Buffer.from(e.privateKey),{network:r}):e.wif&&(n=p.fromWIF(e.wif,r)),e.addressType){case"taproot":const e=this.tweakSigner(n,{network:r}),i=t.payments.p2tr({pubkey:this.toXOnly(e.publicKey),network:r});s=i.address??"",o=i.output;break;case"legacy":const a=t.payments.p2pkh({pubkey:n.publicKey,network:r});s=a.address??"",o=a.output;break;case"segwit":const u=t.payments.p2wpkh({pubkey:n.publicKey,network:r});s=u.address??"",o=u.output}return{address:s,script:o}}catch(e){console.log(e)}},this.init=function(e){try{const{bitcoin:{addresses:t,fees:r,transactions:n}}=h.default({hostname:"mempool.space",network:e});return Promise.resolve({addresses:t,fees:r,transactions:n})}catch(e){return Promise.reject(e)}},this.getAddressType=e=>{let{address:t,networkName:r}=e;try{let e;switch(r){case"mainnet":e=this.mainnetAddressType(t,r);break;case"testnet":e=this.testnetAddressType(t)}return null==e?`invalid ${r} address`:e}catch(e){throw new Error(e.message)}},this.getUtxo=function(t){let{networkName:r,address:n}=t;try{return Promise.resolve(f(function(){return Promise.resolve(e.init(r)).then(function(e){let{addresses:t}=e;return Promise.resolve(t.getAddressTxsUtxo({address:n})).then(function(e){return e.map(e=>({txid:e.txid,vout:e.vout,value:e.value}))})})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.getFeeRate=function(e){try{return Promise.resolve(f(function(){return Promise.resolve(r.init(e)).then(function(e){let{fees:t}=e;return Promise.resolve(t.getFeesRecommended())})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.getTransactionDetails=function(e){let{txid:t,networkName:r}=e;try{return Promise.resolve(f(function(){return Promise.resolve(n.init(r)).then(function(e){let{transactions:r}=e;return Promise.resolve(r.getTx({txid:t}))})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.createTransaction=function(e){let{input:t,output:r,addressType:n,networkName:o,feeRate:i,privateKey:a,wif:u}=e;try{return Promise.resolve(f(function(){return Promise.resolve(s.getInputData(n,t,o,a,u)).then(function(e){let c,h=r,f=0,d=0,l=new Map,p=[];if(a){c=s.createAddress({addressType:n,networkName:o,privateKey:a}).address;let e=s.getAddressType({address:c,networkName:o});l.set(e,1)}else if(a){c=s.createAddress({addressType:n,networkName:o,wif:u}).address;let e=s.getAddressType({address:c,networkName:o});l.set(e,1)}t.forEach(e=>{f+=e.value}),r.forEach(e=>{let t=s.getAddressType({address:e.address,networkName:o});d+=e.value,l.has(t)?l.set(t,l.get(t)+1):l.set(t,1)}),l.forEach((e,t)=>{p.push({outputType:t,count:e})});let v=s.getTransactionSize({input:t.length,output:p,addressType:n}),m=v.txBytes*i;if(console.log(m),f-m-d<=550)return new Error("not enough sats in input for transaction");h.push({address:c,value:f-d-m});let y=s.signTransaction({input:e,output:h,addressType:n,networkName:o,privateKey:a});return console.log(y),{input:e,output:h,transactionFee:m,transactionSize:v,totalSpent:d+m}})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.signTransaction=e=>{try{const r=this.getNetwork(e.networkName);let n;e.privateKey?n=p.fromPrivateKey(Buffer.from(e.privateKey),{network:r}):e.wif&&(n=p.fromWIF(e.wif,r)),"taproot"===e.addressType&&(n=this.tweakSigner(n,r));const s=new t.Psbt({network:r}).addInputs(e.input).addOutputs(e.output).signAllInputs(n).finalizeAllInputs().extractTransaction();return{txHex:s.toHex(),signedTransaction:s}}catch(e){throw new Error(e.message)}},this.createSingleTransaction=function(e){let{receiver:t,amount:r,addressType:n,networkName:s,feeRate:o,privateKey:a,wif:u}=e;try{return Promise.resolve(f(function(){let e,c=[],h=[],f=0,d=new Map,l=[];if(h.push({address:t,value:r}),a){e=i.createAddress({addressType:n,networkName:s,privateKey:a}).address;let t=i.getAddressType({address:e,networkName:s});d.set(t,1)}else if(u){e=i.createAddress({addressType:n,networkName:s,wif:u}).address;let t=i.getAddressType({address:e,networkName:s});d.set(t,1)}return d.forEach((e,t)=>{l.push({outputType:t,count:e})}),Promise.resolve(i.getUtxo({networkName:s,address:e})).then(function(e){for(let t=0;t<e.length;t++){let s=0;c.length>0&&(s=c.length),f+=e[t].value;let a=i.getTransactionSize({input:s,output:l,addressType:n});if(!(f-a.txBytes*o-r<550)){c.push({txid:e[t].txid,vout:e[t].vout,value:e[t].value});break}c.push({txid:e[t].txid,vout:e[t].vout,value:e[t].value})}let t,d=i.getTransactionSize({input:c.length,output:l,addressType:n});if(f<d.txBytes*o+r+550)throw new Error("available balance is not sufficient for transaction");const p=function(){if(a)return Promise.resolve(i.createTransaction({input:c,output:h,addressType:n,networkName:s,feeRate:o,privateKey:a})).then(function(e){t=e});{const e=function(){if(u)return Promise.resolve(i.createTransaction({input:c,output:h,addressType:n,networkName:s,feeRate:o,privateKey:a})).then(function(e){t=e})}();if(e&&e.then)return e.then(function(){})}}();return p&&p.then?p.then(function(){return t}):t})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.getInputData=function(e,t,r,n,s){return Promise.resolve(f(function(){return Promise.resolve(a.init(r)).then(function(o){let i,u,{transactions:c}=o,h=a.getNetwork(r);return Promise.resolve(Promise.all(t.map(function(e){try{return Promise.resolve(c.getTx({txid:e.txid})).then(function(t){return{tx:t,vout:e.vout}})}catch(e){return Promise.reject(e)}}))).then(function(r){let o;const f=function(e,t){var r,n=-1;e:{for(var s=0;s<t.length;s++){var o=t[s][0];if(o){var i=o();if(i&&i.then)break e;if(i===e){n=s;break}}else n=s}if(-1!==n){do{for(var a=t[n][1];!a;)n++,a=t[n][1];var u=a();if(u&&u.then){r=!0;break e}var c=t[n][2];n++}while(c&&!c());return u}}const h=new l,f=d.bind(null,h,2);return(r?u.then(p):i.then(function r(i){for(;;){if(i===e){n=s;break}if(++s===t.length){if(-1!==n)break;return void d(h,1,u)}if(o=t[s][0]){if((i=o())&&i.then)return void i.then(r).then(void 0,f)}else n=s}do{for(var a=t[n][1];!a;)n++,a=t[n][1];var u=a();if(u&&u.then)return void u.then(p).then(void 0,f);var c=t[n][2];n++}while(c&&!c());d(h,1,u)})).then(void 0,f),h;function p(e){for(;;){var r=t[n][2];if(!r||r())break;n++;for(var s=t[n][1];!s;)n++,s=t[n][1];if((e=s())&&e.then)return void e.then(p).then(void 0,f)}d(h,1,e)}}(e,[[function(){return"legacy"},function(){return Promise.resolve(Promise.all(t.map(function(e){try{const t=Buffer,r=t.from;return Promise.resolve(c.getTxHex({txid:e.txid})).then(function(n){return{txHex:r.call(t,n,"hex"),hash:e.txid,index:e.vout}})}catch(e){return Promise.reject(e)}}))).then(function(e){u=e.map(function(e){try{return Promise.resolve({hash:e.hash,index:e.index,nonWitnessUtxo:e.txHex})}catch(e){return Promise.reject(e)}}),o=1})}],[function(){return"segwit"},function(){u=r.map(e=>({hash:e.tx.txid,index:e.vout,witnessUtxo:{value:e.tx.vout[e.vout].value,script:Buffer.from(e.tx.vout[e.vout].scriptpubkey,"hex")}})),o=1}],[function(){return"taproot"},function(){n?i=p.fromPrivateKey(Buffer.from(n),{network:h}):s&&(i=p.fromWIF(s,h));let e=a.tweakSigner(i,{network:h});u=r.map(t=>({hash:t.tx.txid,index:t.vout,witnessUtxo:{value:t.tx.vout[t.vout].value,script:Buffer.from(t.tx.vout[t.vout].scriptpubkey,"hex")},tapInternalKey:a.toXOnly(e.publicKey)})),o=1}]]);return f&&f.then?f.then(function(){return u}):u})})},function(){}))},this.getTransactionSize=e=>{let{input:t,output:r,addressType:n}=e;try{const e=148,s=34,o=32,i=67.75,a=31,u=43,c=57.25;let h,f=0,d=0,l=0,p=0;r.forEach(e=>{"P2TR"===e.outputType?l=e.count:"P2WPKH"===e.outputType?d=e.count:"P2TR"===e.outputType?l=e.count:"P2PKH"===e.outputType&&(f=e.count)});let v=0,m=0;switch(n){case"taproot":h="P2TR",v=c,m=108;break;case"segwit":h="P2WPKH",v=i,m=108;break;case"legacy":h="P2PKH",v=e}let y=this.getTxOverheadVBytes(h,t,r.length)+v*t+s*f+a*d+u*l+o*p;return y=Math.ceil(y),{txVBytes:y,txBytes:Math.ceil(this.getTxOverheadExtraRawBytes(h,t)+y+m*t*3/4),txWeight:Math.ceil(4*y)}}catch(e){throw new Error(e.message)}},this.getNetwork=e=>"mainnet"===e?t.networks.bitcoin:"testnet"===e?t.networks.testnet:void 0,this.getKeyPair=(e,t)=>{const r=e.slice(0,32),n=this.getNetwork(t);return p.fromPrivateKey(Buffer.from(r),{network:n})},this.mainnetAddressType=(e,t)=>{try{const r=e.trim();return/^1[0-9A-Za-z]{25,34}$/.test(r)?"P2PKH":/^3[0-9A-Za-z]{25,34}$/.test(r)?"P2SH":1==this.checkTaproot(r,t)?"P2TR":1==this.checkSegwit(r,t)?"P2WPKH":null}catch(e){throw new Error(e.message)}},this.testnetAddressType=e=>{try{const t=e.trim();if(/^m[0-9A-Za-z]{25,34}$/.test(t))return"P2PKH";if(/^2[0-9A-Za-z]{25,34}$/.test(t))return"P2SH";if(/^(tb1|[mn2])[a-zA-HJ-NP-Z0-9]{25,39}$/.test(t)){if(t.startsWith("tb1q"))return"P2WPKH";if(t.startsWith("tb1p"))return"P2TR"}return null}catch(e){throw new Error(e.message)}},this.checkTaproot=(e,t)=>{try{if("mainnet"===t&&e.startsWith("tb1q"))return!1;if("mainnet"===t&&e.startsWith("tb1p"))return!1;if(1===o.bech32m.decode(e).words[0])return!0}catch(e){return!1}},this.checkSegwit=(e,t)=>{try{if("mainnet"===t&&e.startsWith("tb1q"))return!1;if("mainnet"===t&&e.startsWith("tb1p"))return!1;if(0===o.bech32.decode(e).words[0])return!0}catch(e){return!1}},this.getSizeOfScriptLengthElement=e=>e<75?1:e<=255?2:e<=65535?3:e<=4294967295?5:void alert("Size of redeem script is too large"),this.getSizeOfVarInt=e=>{if(e<253)return 1;if(e<65535)return 3;if(e<4294967295)return 5;if(e<0x10000000000000000)return 9;throw new Error("Invalid var int")},this.getTxOverheadVBytes=(e,t,r)=>{if("P2PKH"==e||"P2SH"==e)var n=0;else n=.5+t/4;return 4+this.getSizeOfVarInt(t)+this.getSizeOfVarInt(r)+4+n},this.getTxOverheadExtraRawBytes=(e,t)=>{if("P2PKH"==e||"P2SH"==e)var r=0;else r=.5+t/4;return 3*r}}tweakSigner(e,t){let r=e.privateKey;if(!r)throw new Error("Private key is required for tweaking signer!");3===e.publicKey[0]&&(r=c.privateNegate(r));const n=c.privateAdd(r,this.tapTweakHash(this.toXOnly(e.publicKey),t.tweakHash));if(!n)throw new Error("Invalid tweaked private key!");return p.fromPrivateKey(Buffer.from(n),{network:t.network})}tapTweakHash(e,r){return t.crypto.taggedHash("TapTweak",Buffer.concat(r?[e,r]:[e]))}toXOnly(e){return e.subarray(1,33)}}class m extends v{}var y;y=m,[v].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(t=>{Object.defineProperty(y.prototype,t,Object.getOwnPropertyDescriptor(e.prototype,t)||Object.create(null))})}),module.exports=m;
