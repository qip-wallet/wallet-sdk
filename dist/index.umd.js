!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("bitcore-mnemonic"),require("bitcoinjs-lib"),require("tiny-secp256k1"),require("ecpair"),require("@mempool/mempool.js"),require("bech32")):"function"==typeof define&&define.amd?define(["bitcore-mnemonic","bitcoinjs-lib","tiny-secp256k1","ecpair","@mempool/mempool.js","bech32"],t):(e||self).qipWalletSdk=t(e.bitcoreMnemonic,e.bitcoinjsLib,e.tinySecp256K1,e.ecpair,e.mempoolJS,e.bech32)}(this,function(e,t,r,n,s,i){function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function a(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach(function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}}),t.default=e,t}var u=/*#__PURE__*/a(e),c=/*#__PURE__*/a(r),f=/*#__PURE__*/o(s);function h(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}function d(e,t,r){if(!e.s){if(r instanceof p){if(!r.s)return void(r.o=d.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(d.bind(null,e,t),d.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}const p=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){const n=new e,s=this.s;if(s){const e=1&s?t:r;if(e){try{d(n,1,e(this.v))}catch(e){d(n,2,e)}return n}return this}return this.o=function(e){try{const s=e.v;1&e.s?d(n,1,t?t(s):s):r?d(n,1,r(s)):d(n,2,s)}catch(e){d(n,2,e)}},n},e}();t.initEccLib(c);const l=n.ECPairFactory(c);class m{constructor(){const e=this,r=this,n=this,s=this,o=this,a=this;this.createPassPhrase=()=>{try{return{passPhrase:new u(u.Words.ENGLISH).toString()}}catch(e){throw new Error(e.message)}},this.accountKeys=e=>{try{const t=this.getNetwork(e.networkName);let r=new u(e.passPhrase).toHDPrivateKey(e.passPhrase).derive(`m/44/0/0/0/${e.path}`).privateKey.toString(),n=l.fromPrivateKey(Buffer.from(r.slice(0,32)),{network:t});return{privateKey:n.privateKey.toString(),wif:n.toWIF()}}catch(e){throw new Error(e.message)}},this.createAddress=e=>{try{const r=this.getNetwork(e.networkName);let n,s,i;switch(e.privateKey?n=l.fromPrivateKey(Buffer.from(e.privateKey),{network:r}):e.wif&&(n=l.fromWIF(e.wif,r)),e.addressType){case"taproot":const e=this.tweakSigner(n,{network:r}),o=t.payments.p2tr({pubkey:this.toXOnly(e.publicKey),network:r});s=o.address??"",i=o.output;break;case"legacy":const a=t.payments.p2pkh({pubkey:n.publicKey,network:r});s=a.address??"",i=a.output;break;case"segwit":const u=t.payments.p2wpkh({pubkey:n.publicKey,network:r});s=u.address??"",i=u.output}return{address:s,script:i}}catch(e){console.log(e)}},this.init=function(e){try{const{bitcoin:{addresses:t,fees:r,transactions:n}}=f.default({hostname:"mempool.space",network:e});return Promise.resolve({addresses:t,fees:r,transactions:n})}catch(e){return Promise.reject(e)}},this.getAddressType=e=>{let{address:t,networkName:r}=e;try{let e;switch(r){case"mainnet":e=this.mainnetAddressType(t,r);break;case"testnet":e=this.testnetAddressType(t)}return null==e?`invalid ${r} address`:e}catch(e){throw new Error(e.message)}},this.getUtxo=function(t){let{networkName:r,address:n}=t;try{return Promise.resolve(h(function(){return Promise.resolve(e.init(r)).then(function(e){let{addresses:t}=e;return Promise.resolve(t.getAddressTxsUtxo({address:n})).then(function(e){return e.map(e=>({txid:e.txid,vout:e.vout,value:e.value}))})})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.getFeeRate=function(e){try{return Promise.resolve(h(function(){return Promise.resolve(r.init(e)).then(function(e){let{fees:t}=e;return Promise.resolve(t.getFeesRecommended())})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.getTransactionDetails=function(e){let{txid:t,networkName:r}=e;try{return Promise.resolve(h(function(){return Promise.resolve(n.init(r)).then(function(e){let{transactions:r}=e;return Promise.resolve(r.getTx({txid:t}))})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.createTransaction=function(e){let{input:t,output:r,addressType:n,networkName:i,feeRate:o,privateKey:a,wif:u}=e;try{return Promise.resolve(h(function(){return Promise.resolve(s.getInputData(n,t,i,a,u)).then(function(e){let c,f=r,h=0,d=0,p=new Map,l=[];if(a){c=s.createAddress({addressType:n,networkName:i,privateKey:a}).address;let e=s.getAddressType({address:c,networkName:i});p.set(e,1)}else if(a){c=s.createAddress({addressType:n,networkName:i,wif:u}).address;let e=s.getAddressType({address:c,networkName:i});p.set(e,1)}t.forEach(e=>{h+=e.value}),r.forEach(e=>{let t=s.getAddressType({address:e.address,networkName:i});d+=e.value,p.has(t)?p.set(t,p.get(t)+1):p.set(t,1)}),p.forEach((e,t)=>{l.push({outputType:t,count:e})});let m=s.getTransactionSize({input:t.length,output:l,addressType:n}),y=m.txBytes*o;if(console.log(y),h-y-d<=550)return new Error("not enough sats in input for transaction");f.push({address:c,value:h-d-y});let v=s.signTransaction({input:e,output:f,addressType:n,networkName:i,privateKey:a});return console.log(v),{input:e,output:f,transactionFee:y,transactionSize:m,totalSpent:d+y}})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.signTransaction=e=>{try{const r=this.getNetwork(e.networkName);let n;e.privateKey?n=l.fromPrivateKey(Buffer.from(e.privateKey),{network:r}):e.wif&&(n=l.fromWIF(e.wif,r)),"taproot"===e.addressType&&(n=this.tweakSigner(n,r));const s=new t.Psbt({network:r}).addInputs(e.input).addOutputs(e.output).signAllInputs(n).finalizeAllInputs().extractTransaction();return{txHex:s.toHex(),signedTransaction:s}}catch(e){throw new Error(e.message)}},this.createSingleTransaction=function(e){let{receiver:t,amount:r,addressType:n,networkName:s,feeRate:i,privateKey:a,wif:u}=e;try{return Promise.resolve(h(function(){let e,c=[],f=[],h=0,d=new Map,p=[];if(f.push({address:t,value:r}),a){e=o.createAddress({addressType:n,networkName:s,privateKey:a}).address;let t=o.getAddressType({address:e,networkName:s});d.set(t,1)}else if(u){e=o.createAddress({addressType:n,networkName:s,wif:u}).address;let t=o.getAddressType({address:e,networkName:s});d.set(t,1)}return d.forEach((e,t)=>{p.push({outputType:t,count:e})}),Promise.resolve(o.getUtxo({networkName:s,address:e})).then(function(e){for(let t=0;t<e.length;t++){let s=0;c.length>0&&(s=c.length),h+=e[t].value;let a=o.getTransactionSize({input:s,output:p,addressType:n});if(!(h-a.txBytes*i-r<550)){c.push({txid:e[t].txid,vout:e[t].vout,value:e[t].value});break}c.push({txid:e[t].txid,vout:e[t].vout,value:e[t].value})}let t,d=o.getTransactionSize({input:c.length,output:p,addressType:n});if(h<d.txBytes*i+r+550)throw new Error("available balance is not sufficient for transaction");const l=function(){if(a)return Promise.resolve(o.createTransaction({input:c,output:f,addressType:n,networkName:s,feeRate:i,privateKey:a})).then(function(e){t=e});{const e=function(){if(u)return Promise.resolve(o.createTransaction({input:c,output:f,addressType:n,networkName:s,feeRate:i,privateKey:a})).then(function(e){t=e})}();if(e&&e.then)return e.then(function(){})}}();return l&&l.then?l.then(function(){return t}):t})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.getInputData=function(e,t,r,n,s){return Promise.resolve(h(function(){return Promise.resolve(a.init(r)).then(function(i){let o,u,{transactions:c}=i,f=a.getNetwork(r);return Promise.resolve(Promise.all(t.map(function(e){try{return Promise.resolve(c.getTx({txid:e.txid})).then(function(t){return{tx:t,vout:e.vout}})}catch(e){return Promise.reject(e)}}))).then(function(r){let i;const h=function(e,t){var r,n=-1;e:{for(var s=0;s<t.length;s++){var i=t[s][0];if(i){var o=i();if(o&&o.then)break e;if(o===e){n=s;break}}else n=s}if(-1!==n){do{for(var a=t[n][1];!a;)n++,a=t[n][1];var u=a();if(u&&u.then){r=!0;break e}var c=t[n][2];n++}while(c&&!c());return u}}const f=new p,h=d.bind(null,f,2);return(r?u.then(l):o.then(function r(o){for(;;){if(o===e){n=s;break}if(++s===t.length){if(-1!==n)break;return void d(f,1,u)}if(i=t[s][0]){if((o=i())&&o.then)return void o.then(r).then(void 0,h)}else n=s}do{for(var a=t[n][1];!a;)n++,a=t[n][1];var u=a();if(u&&u.then)return void u.then(l).then(void 0,h);var c=t[n][2];n++}while(c&&!c());d(f,1,u)})).then(void 0,h),f;function l(e){for(;;){var r=t[n][2];if(!r||r())break;n++;for(var s=t[n][1];!s;)n++,s=t[n][1];if((e=s())&&e.then)return void e.then(l).then(void 0,h)}d(f,1,e)}}(e,[[function(){return"legacy"},function(){return Promise.resolve(Promise.all(t.map(function(e){try{const t=Buffer,r=t.from;return Promise.resolve(c.getTxHex({txid:e.txid})).then(function(n){return{txHex:r.call(t,n,"hex"),hash:e.txid,index:e.vout}})}catch(e){return Promise.reject(e)}}))).then(function(e){u=e.map(function(e){try{return Promise.resolve({hash:e.hash,index:e.index,nonWitnessUtxo:e.txHex})}catch(e){return Promise.reject(e)}}),i=1})}],[function(){return"segwit"},function(){u=r.map(e=>({hash:e.tx.txid,index:e.vout,witnessUtxo:{value:e.tx.vout[e.vout].value,script:Buffer.from(e.tx.vout[e.vout].scriptpubkey,"hex")}})),i=1}],[function(){return"taproot"},function(){n?o=l.fromPrivateKey(Buffer.from(n),{network:f}):s&&(o=l.fromWIF(s,f));let e=a.tweakSigner(o,{network:f});u=r.map(t=>({hash:t.tx.txid,index:t.vout,witnessUtxo:{value:t.tx.vout[t.vout].value,script:Buffer.from(t.tx.vout[t.vout].scriptpubkey,"hex")},tapInternalKey:a.toXOnly(e.publicKey)})),i=1}]]);return h&&h.then?h.then(function(){return u}):u})})},function(){}))},this.getTransactionSize=e=>{let{input:t,output:r,addressType:n}=e;try{const e=148,s=34,i=32,o=67.75,a=31,u=43,c=57.25;let f,h=0,d=0,p=0,l=0;r.forEach(e=>{"P2TR"===e.outputType?p=e.count:"P2WPKH"===e.outputType?d=e.count:"P2TR"===e.outputType?p=e.count:"P2PKH"===e.outputType&&(h=e.count)});let m=0,y=0;switch(n){case"taproot":f="P2TR",m=c,y=108;break;case"segwit":f="P2WPKH",m=o,y=108;break;case"legacy":f="P2PKH",m=e}let v=this.getTxOverheadVBytes(f,t,r.length)+m*t+s*h+a*d+u*p+i*l;return v=Math.ceil(v),{txVBytes:v,txBytes:Math.ceil(this.getTxOverheadExtraRawBytes(f,t)+v+y*t*3/4),txWeight:Math.ceil(4*v)}}catch(e){throw new Error(e.message)}},this.getNetwork=e=>"mainnet"===e?t.networks.bitcoin:"testnet"===e?t.networks.testnet:void 0,this.getKeyPair=(e,t)=>{const r=e.slice(0,32),n=this.getNetwork(t);return l.fromPrivateKey(Buffer.from(r),{network:n})},this.mainnetAddressType=(e,t)=>{try{const r=e.trim();return/^1[0-9A-Za-z]{25,34}$/.test(r)?"P2PKH":/^3[0-9A-Za-z]{25,34}$/.test(r)?"P2SH":1==this.checkTaproot(r,t)?"P2TR":1==this.checkSegwit(r,t)?"P2WPKH":null}catch(e){throw new Error(e.message)}},this.testnetAddressType=e=>{try{const t=e.trim();if(/^m[0-9A-Za-z]{25,34}$/.test(t))return"P2PKH";if(/^2[0-9A-Za-z]{25,34}$/.test(t))return"P2SH";if(/^(tb1|[mn2])[a-zA-HJ-NP-Z0-9]{25,39}$/.test(t)){if(t.startsWith("tb1q"))return"P2WPKH";if(t.startsWith("tb1p"))return"P2TR"}return null}catch(e){throw new Error(e.message)}},this.checkTaproot=(e,t)=>{try{if("mainnet"===t&&e.startsWith("tb1q"))return!1;if("mainnet"===t&&e.startsWith("tb1p"))return!1;if(1===i.bech32m.decode(e).words[0])return!0}catch(e){return!1}},this.checkSegwit=(e,t)=>{try{if("mainnet"===t&&e.startsWith("tb1q"))return!1;if("mainnet"===t&&e.startsWith("tb1p"))return!1;if(0===i.bech32.decode(e).words[0])return!0}catch(e){return!1}},this.getSizeOfScriptLengthElement=e=>e<75?1:e<=255?2:e<=65535?3:e<=4294967295?5:void alert("Size of redeem script is too large"),this.getSizeOfVarInt=e=>{if(e<253)return 1;if(e<65535)return 3;if(e<4294967295)return 5;if(e<0x10000000000000000)return 9;throw new Error("Invalid var int")},this.getTxOverheadVBytes=(e,t,r)=>{if("P2PKH"==e||"P2SH"==e)var n=0;else n=.5+t/4;return 4+this.getSizeOfVarInt(t)+this.getSizeOfVarInt(r)+4+n},this.getTxOverheadExtraRawBytes=(e,t)=>{if("P2PKH"==e||"P2SH"==e)var r=0;else r=.5+t/4;return 3*r}}tweakSigner(e,t){let r=e.privateKey;if(!r)throw new Error("Private key is required for tweaking signer!");3===e.publicKey[0]&&(r=c.privateNegate(r));const n=c.privateAdd(r,this.tapTweakHash(this.toXOnly(e.publicKey),t.tweakHash));if(!n)throw new Error("Invalid tweaked private key!");return l.fromPrivateKey(Buffer.from(n),{network:t.network})}tapTweakHash(e,r){return t.crypto.taggedHash("TapTweak",Buffer.concat(r?[e,r]:[e]))}toXOnly(e){return e.subarray(1,33)}}class y extends m{}var v;return v=y,[m].forEach(e=>{Object.getOwnPropertyNames(e.prototype).forEach(t=>{Object.defineProperty(v.prototype,t,Object.getOwnPropertyDescriptor(e.prototype,t)||Object.create(null))})}),y});
