import*as e from"bitcore-mnemonic";import{initEccLib as t,crypto as r,payments as n,Psbt as o,networks as i}from"bitcoinjs-lib";import*as a from"tiny-secp256k1";import{ECPairFactory as s}from"ecpair";import u from"@mempool/mempool.js";import{bech32m as c,bech32 as f}from"bech32";function h(e,t){return h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},h(e,t)}function d(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}function v(e,t,r){if(!e.s){if(r instanceof p){if(!r.s)return void(r.o=v.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(v.bind(null,e,t),v.bind(null,e,2));e.s=t,e.v=r;var n=e.o;n&&n(e)}}var p=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,r){var n=new e,o=this.s;if(o){var i=1&o?t:r;if(i){try{v(n,1,i(this.v))}catch(e){v(n,2,e)}return n}return this}return this.o=function(e){try{var o=e.v;1&e.s?v(n,1,t?t(o):o):r?v(n,1,r(o)):v(n,2,o)}catch(e){v(n,2,e)}},n},e}();t(a);var m,l=s(a),y=/*#__PURE__*/function(){function t(){var t=this,r=this,a=this,s=this,h=this,m=this,y=this;this.createPassPhrase=function(){try{return{passPhrase:new e(e.Words.ENGLISH).toString()}}catch(e){throw new Error(e.message)}},this.accountKeys=function(t){try{var r=y.getNetwork(t.networkName),n=new e(t.passPhrase).toHDPrivateKey(t.passPhrase).derive("m/44/0/0/0/"+t.path).privateKey.toString(),o=l.fromPrivateKey(Buffer.from(n.slice(0,32)),{network:r});return{privateKey:o.privateKey.toString(),wif:o.toWIF()}}catch(e){throw new Error(e.message)}},this.createAddress=function(e){var t,r,o;try{var i,a,s,u=y.getNetwork(e.networkName);switch(e.privateKey?i=l.fromPrivateKey(Buffer.from(e.privateKey),{network:u}):e.wif&&(i=l.fromWIF(e.wif,u)),e.addressType){case"taproot":var c=y.tweakSigner(i,{network:u}),f=n.p2tr({pubkey:y.toXOnly(c.publicKey),network:u});a=null!=(t=f.address)?t:"",s=f.output;break;case"legacy":var h=n.p2pkh({pubkey:i.publicKey,network:u});a=null!=(r=h.address)?r:"",s=h.output;break;case"segwit":var d=n.p2wpkh({pubkey:i.publicKey,network:u});a=null!=(o=d.address)?o:"",s=d.output}return{address:a,script:s}}catch(e){console.log(e)}},this.init=function(e){try{var t=u({hostname:"mempool.space",network:e}).bitcoin;return Promise.resolve({addresses:t.addresses,fees:t.fees,transactions:t.transactions})}catch(e){return Promise.reject(e)}},this.getAddressType=function(e){var t=e.address,r=e.networkName;try{var n;switch(r){case"mainnet":n=y.mainnetAddressType(t,r);break;case"testnet":n=y.testnetAddressType(t)}return null==n?"invalid "+r+" address":n}catch(e){throw new Error(e.message)}},this.getUtxo=function(e){var r=e.networkName,n=e.address;try{return Promise.resolve(d(function(){return Promise.resolve(t.init(r)).then(function(e){return Promise.resolve(e.addresses.getAddressTxsUtxo({address:n})).then(function(e){return e.map(function(e){return{txid:e.txid,vout:e.vout,value:e.value}})})})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.getFeeRate=function(e){try{return Promise.resolve(d(function(){return Promise.resolve(r.init(e)).then(function(e){return Promise.resolve(e.fees.getFeesRecommended())})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.getTransactionDetails=function(e){var t=e.txid,r=e.networkName;try{return Promise.resolve(d(function(){return Promise.resolve(a.init(r)).then(function(e){return Promise.resolve(e.transactions.getTx({txid:t}))})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.createTransaction=function(e){var t=e.input,r=e.output,n=e.addressType,o=e.networkName,i=e.feeRate,a=e.privateKey,u=e.wif;try{return Promise.resolve(d(function(){return Promise.resolve(s.getInputData(n,t,o,a,u)).then(function(e){var c,f=r,h=0,d=0,v=new Map,p=[];if(a){c=s.createAddress({addressType:n,networkName:o,privateKey:a}).address;var m=s.getAddressType({address:c,networkName:o});v.set(m,1)}else if(a){c=s.createAddress({addressType:n,networkName:o,wif:u}).address;var l=s.getAddressType({address:c,networkName:o});v.set(l,1)}t.forEach(function(e){h+=e.value}),r.forEach(function(e){var t=s.getAddressType({address:e.address,networkName:o});d+=e.value,v.has(t)?v.set(t,v.get(t)+1):v.set(t,1)}),v.forEach(function(e,t){p.push({outputType:t,count:e})});var y=s.getTransactionSize({input:t.length,output:p,addressType:n}),w=y.txBytes*i;if(console.log(w),h-w-d<=550)return new Error("not enough sats in input for transaction");f.push({address:c,value:h-d-w});var g=s.signTransaction({input:e,output:f,addressType:n,networkName:o,privateKey:a});return console.log(g),{input:e,output:f,transactionFee:w,transactionSize:y,totalSpent:d+w}})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.signTransaction=function(e){try{var t,r=y.getNetwork(e.networkName);e.privateKey?t=l.fromPrivateKey(Buffer.from(e.privateKey),{network:r}):e.wif&&(t=l.fromWIF(e.wif,r)),"taproot"===e.addressType&&(t=y.tweakSigner(t,r));var n=new o({network:r}).addInputs(e.input).addOutputs(e.output).signAllInputs(t).finalizeAllInputs().extractTransaction();return{txHex:n.toHex(),signedTransaction:n}}catch(e){throw new Error(e.message)}},this.createSingleTransaction=function(e){var t=e.receiver,r=e.amount,n=e.addressType,o=e.networkName,i=e.feeRate,a=e.privateKey,s=e.wif;try{return Promise.resolve(d(function(){var e,u=[],c=[],f=0,d=new Map,v=[];if(c.push({address:t,value:r}),a){e=h.createAddress({addressType:n,networkName:o,privateKey:a}).address;var p=h.getAddressType({address:e,networkName:o});d.set(p,1)}else if(s){e=h.createAddress({addressType:n,networkName:o,wif:s}).address;var m=h.getAddressType({address:e,networkName:o});d.set(m,1)}return d.forEach(function(e,t){v.push({outputType:t,count:e})}),Promise.resolve(h.getUtxo({networkName:o,address:e})).then(function(e){for(var t=0;t<e.length;t++){var d=0;u.length>0&&(d=u.length),f+=e[t].value;var p=h.getTransactionSize({input:d,output:v,addressType:n});if(!(f-p.txBytes*i-r<550)){u.push({txid:e[t].txid,vout:e[t].vout,value:e[t].value});break}u.push({txid:e[t].txid,vout:e[t].vout,value:e[t].value})}var m,l=h.getTransactionSize({input:u.length,output:v,addressType:n});if(f<l.txBytes*i+r+550)throw new Error("available balance is not sufficient for transaction");var y=function(){if(a)return Promise.resolve(h.createTransaction({input:u,output:c,addressType:n,networkName:o,feeRate:i,privateKey:a})).then(function(e){m=e});var e=function(){if(s)return Promise.resolve(h.createTransaction({input:u,output:c,addressType:n,networkName:o,feeRate:i,privateKey:a})).then(function(e){m=e})}();return e&&e.then?e.then(function(){}):void 0}();return y&&y.then?y.then(function(){return m}):m})},function(e){throw new Error(e.message)}))}catch(e){return Promise.reject(e)}},this.getInputData=function(e,t,r,n,o){return Promise.resolve(d(function(){return Promise.resolve(m.init(r)).then(function(i){var a,s,u=i.transactions,c=m.getNetwork(r);return Promise.resolve(Promise.all(t.map(function(e){try{return Promise.resolve(u.getTx({txid:e.txid})).then(function(t){return{tx:t,vout:e.vout}})}catch(e){return Promise.reject(e)}}))).then(function(r){var i=function(e,t){var r,n=-1;e:{for(var o=0;o<t.length;o++){var i=t[o][0];if(i){var a=i();if(a&&a.then)break e;if(a===e){n=o;break}}else n=o}if(-1!==n){do{for(var s=t[n][1];!s;)n++,s=t[n][1];var u=s();if(u&&u.then){r=!0;break e}var c=t[n][2];n++}while(c&&!c());return u}}var f=new p,h=v.bind(null,f,2);return(r?u.then(d):a.then(function r(a){for(;;){if(a===e){n=o;break}if(++o===t.length){if(-1!==n)break;return void v(f,1,u)}if(i=t[o][0]){if((a=i())&&a.then)return void a.then(r).then(void 0,h)}else n=o}do{for(var s=t[n][1];!s;)n++,s=t[n][1];var u=s();if(u&&u.then)return void u.then(d).then(void 0,h);var c=t[n][2];n++}while(c&&!c());v(f,1,u)})).then(void 0,h),f;function d(e){for(;;){var r=t[n][2];if(!r||r())break;n++;for(var o=t[n][1];!o;)n++,o=t[n][1];if((e=o())&&e.then)return void e.then(d).then(void 0,h)}v(f,1,e)}}(e,[[function(){return"legacy"},function(){return Promise.resolve(Promise.all(t.map(function(e){try{var t=Buffer,r=t.from;return Promise.resolve(u.getTxHex({txid:e.txid})).then(function(n){return{txHex:r.call(t,n,"hex"),hash:e.txid,index:e.vout}})}catch(e){return Promise.reject(e)}}))).then(function(e){s=e.map(function(e){try{return Promise.resolve({hash:e.hash,index:e.index,nonWitnessUtxo:e.txHex})}catch(e){return Promise.reject(e)}})})}],[function(){return"segwit"},function(){s=r.map(function(e){return{hash:e.tx.txid,index:e.vout,witnessUtxo:{value:e.tx.vout[e.vout].value,script:Buffer.from(e.tx.vout[e.vout].scriptpubkey,"hex")}}})}],[function(){return"taproot"},function(){n?a=l.fromPrivateKey(Buffer.from(n),{network:c}):o&&(a=l.fromWIF(o,c));var e=m.tweakSigner(a,{network:c});s=r.map(function(t){return{hash:t.tx.txid,index:t.vout,witnessUtxo:{value:t.tx.vout[t.vout].value,script:Buffer.from(t.tx.vout[t.vout].scriptpubkey,"hex")},tapInternalKey:m.toXOnly(e.publicKey)}})}]]);return i&&i.then?i.then(function(){return s}):s})})},function(){}))},this.getTransactionSize=function(e){var t=e.input,r=e.output,n=e.addressType;try{var o,i=0,a=0,s=0;r.forEach(function(e){"P2TR"===e.outputType?s=e.count:"P2WPKH"===e.outputType?a=e.count:"P2TR"===e.outputType?s=e.count:"P2PKH"===e.outputType&&(i=e.count)});var u=0,c=0;switch(n){case"taproot":o="P2TR",u=57.25,c=108;break;case"segwit":o="P2WPKH",u=67.75,c=108;break;case"legacy":o="P2PKH",u=148}var f=y.getTxOverheadVBytes(o,t,r.length)+u*t+34*i+31*a+43*s+0;return{txVBytes:f=Math.ceil(f),txBytes:Math.ceil(y.getTxOverheadExtraRawBytes(o,t)+f+c*t*3/4),txWeight:Math.ceil(4*f)}}catch(e){throw new Error(e.message)}},this.getNetwork=function(e){return"mainnet"===e?i.bitcoin:"testnet"===e?i.testnet:void 0},this.getKeyPair=function(e,t){var r=e.slice(0,32),n=y.getNetwork(t);return l.fromPrivateKey(Buffer.from(r),{network:n})},this.mainnetAddressType=function(e,t){try{var r=e.trim();return/^1[0-9A-Za-z]{25,34}$/.test(r)?"P2PKH":/^3[0-9A-Za-z]{25,34}$/.test(r)?"P2SH":1==y.checkTaproot(r,t)?"P2TR":1==y.checkSegwit(r,t)?"P2WPKH":null}catch(e){throw new Error(e.message)}},this.testnetAddressType=function(e){try{var t=e.trim();if(/^m[0-9A-Za-z]{25,34}$/.test(t))return"P2PKH";if(/^2[0-9A-Za-z]{25,34}$/.test(t))return"P2SH";if(/^(tb1|[mn2])[a-zA-HJ-NP-Z0-9]{25,39}$/.test(t)){if(t.startsWith("tb1q"))return"P2WPKH";if(t.startsWith("tb1p"))return"P2TR"}return null}catch(e){throw new Error(e.message)}},this.checkTaproot=function(e,t){try{if("mainnet"===t&&e.startsWith("tb1q"))return!1;if("mainnet"===t&&e.startsWith("tb1p"))return!1;if(1===c.decode(e).words[0])return!0}catch(e){return!1}},this.checkSegwit=function(e,t){try{if("mainnet"===t&&e.startsWith("tb1q"))return!1;if("mainnet"===t&&e.startsWith("tb1p"))return!1;if(0===f.decode(e).words[0])return!0}catch(e){return!1}},this.getSizeOfScriptLengthElement=function(e){return e<75?1:e<=255?2:e<=65535?3:e<=4294967295?5:void alert("Size of redeem script is too large")},this.getSizeOfVarInt=function(e){if(e<253)return 1;if(e<65535)return 3;if(e<4294967295)return 5;if(e<0x10000000000000000)return 9;throw new Error("Invalid var int")},this.getTxOverheadVBytes=function(e,t,r){if("P2PKH"==e||"P2SH"==e)var n=0;else n=.5+t/4;return 4+y.getSizeOfVarInt(t)+y.getSizeOfVarInt(r)+4+n},this.getTxOverheadExtraRawBytes=function(e,t){if("P2PKH"==e||"P2SH"==e)var r=0;else r=.5+t/4;return 3*r}}var s=t.prototype;return s.tweakSigner=function(e,t){var r=e.privateKey;if(!r)throw new Error("Private key is required for tweaking signer!");3===e.publicKey[0]&&(r=a.privateNegate(r));var n=a.privateAdd(r,this.tapTweakHash(this.toXOnly(e.publicKey),t.tweakHash));if(!n)throw new Error("Invalid tweaked private key!");return l.fromPrivateKey(Buffer.from(n),{network:t.network})},s.tapTweakHash=function(e,t){return r.taggedHash("TapTweak",Buffer.concat(t?[e,t]:[e]))},s.toXOnly=function(e){return e.subarray(1,33)},t}(),w=/*#__PURE__*/function(e){var t,r;function n(){return e.apply(this,arguments)||this}return r=e,(t=n).prototype=Object.create(r.prototype),t.prototype.constructor=t,h(t,r),n}(y);m=w,[y].forEach(function(e){Object.getOwnPropertyNames(e.prototype).forEach(function(t){Object.defineProperty(m.prototype,t,Object.getOwnPropertyDescriptor(e.prototype,t)||Object.create(null))})});export{w as default};
